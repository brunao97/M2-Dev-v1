# M2-Dev Project Rules

## Project Overview
Este √© um projeto Metin2 completo com servidor e cliente. O projeto inclui:
- **m2dev-server**: Servidor Metin2 com gerenciamento web (Node.js/Bun)
- **m2dev-client**: Cliente do jogo Metin2
- **m2dev-server-src**: C√≥digo fonte do servidor (C++)
- **m2dev-client-src**: C√≥digo fonte do cliente (C++)

## Tecnologias Principais
- **Backend**: Node.js/Bun, Python, C++
- **Frontend Web**: HTML, CSS (Tailwind), JavaScript
- **Database**: MySQL/MariaDB
- **Quest System**: Sistema de quests compiladas (.quest -> .qc)

## Regras de Arquivos

### Arquivos .bat (Batch)
- **N√ÉO criar arquivos .bat sem autoriza√ß√£o expl√≠cita**
- Se for necess√°rio criar um arquivo .bat tempor√°rio:
  1. Execute o arquivo imediatamente ap√≥s cria√ß√£o
  2. Delete o arquivo ap√≥s execu√ß√£o bem-sucedida
  3. Informe o usu√°rio sobre a cria√ß√£o e remo√ß√£o

### Arquivos .md (Markdown)
- **N√ÉO criar arquivos .md sem solicita√ß√£o ou aprova√ß√£o expl√≠cita**
- Documenta√ß√£o s√≥ deve ser criada quando explicitamente solicitada
- README.md existentes podem ser atualizados apenas se necess√°rio

### Arquivos Tempor√°rios
- N√£o criar arquivos tempor√°rios desnecess√°rios
- Se criar arquivos tempor√°rios, remov√™-los ap√≥s uso
- Preferir usar vari√°veis de ambiente ou mem√≥ria quando poss√≠vel

## Estrutura do Projeto

### Servidor (m2dev-server)
- **web_manager.js**: Interface web de gerenciamento (porta 8080)
- **start.py**: Script para iniciar servidor
- **stop.py**: Script para parar servidor
- **compile_quests.ps1**: Script PowerShell para compilar quests
- **channels/**: Diret√≥rio com canais do servidor (auth, db, channel1-4, channel99)
- **share/**: Arquivos compartilhados (conf, data, locale)
- **sql/**: Scripts SQL para inicializa√ß√£o do banco de dados

### Quest System
- Quests est√£o em `share/locale/english/quest/`
- Compilador: `qc.exe` (gera arquivos .qc)
- Lista de quests: `locale_list`
- Para compilar: executar `compile_quests.ps1`

### Web Manager
- Interface dark theme com Tailwind CSS
- Porta padr√£o: 8080
- Funcionalidades:
  - Status do sistema (MySQL, Database, Auth, Channels)
  - Controles de opera√ß√£o (Iniciar, Parar, Reiniciar)
  - Visualiza√ß√£o de logs
  - Estat√≠sticas (contas, players)

## Comandos Importantes

### Servidor Web
```bash
cd m2dev-server
bun run dev    # Inicia servidor web na porta 8080
```

### Compilar Quests
```bash
cd m2dev-server
powershell -ExecutionPolicy Bypass -File compile_quests.ps1
```

### Iniciar Servidor Game
```bash
cd m2dev-server
python start.py
```

## Regras de Desenvolvimento

### Compila√ß√£o de C√≥digo Fonte
- **SEMPRE compilar o m√≥dulo correspondente ap√≥s alterar c√≥digo fonte**
- Se alterar c√≥digo em `m2dev-server-src/`: **COMPILAR O SERVIDOR**
  - Usar CMake: `cd m2dev-server-src/build && cmake --build . --target game --config Release`
  - Ou MSBuild: compilar o projeto `game.vcxproj` em modo Release
  - O servidor compila bibliotecas/m√≥dulos, mas **N√ÉO gera execut√°vel** - apenas recompila o c√≥digo fonte
  - Ap√≥s compilar, informar ao usu√°rio que √© necess√°rio reiniciar o servidor
- Se alterar c√≥digo em `m2dev-client-src/`: **COMPILAR O CLIENTE**
  - Seguir processo de compila√ß√£o do cliente correspondente
  - O cliente **GERA EXECUT√ÅVEL** ap√≥s compila√ß√£o
  - Verificar data/hora do execut√°vel ap√≥s compila√ß√£o para confirmar atualiza√ß√£o
  - Ap√≥s compilar, informar ao usu√°rio que √© necess√°rio reiniciar o cliente
- **NUNCA considerar altera√ß√µes conclu√≠das sem compilar o m√≥dulo afetado**

### Antes de Executar Comandos
- **SEMPRE analisar o projeto antes de usar comandos npm, bun, etc.**
- Verificar se as depend√™ncias est√£o instaladas
- Verificar se os arquivos necess√°rios existem

### Testes
- **N√ÉO testar o app automaticamente** (conforme regra do usu√°rio)
- Apenas executar testes quando explicitamente solicitado

### Portas
- Porta 8080: Web Manager
- Verificar se a porta est√° livre antes de iniciar servidor
- Se ocupada, informar ao usu√°rio ou usar porta alternativa

### Banco de Dados
- Scripts SQL em `m2dev-server/sql/`
- Estrutura principal: `account.sql`, `player.sql`, `common.sql`, `log.sql`
- Sempre verificar sintaxe SQL antes de executar

## Quest System Details
- Formato: Arquivos .quest (Lua-like syntax)
- Compilador: qc.exe gera arquivos bin√°rios
- Localiza√ß√£o: `share/locale/english/quest/`
- Total de quests: ~239 (207 compiladas com sucesso)
- Erros comuns: "must start with 'quest'", problemas de sintaxe

## Frontend Web Manager
- Framework: Tailwind CSS (via CDN)
- Tema: Dark mode (class-based)
- √çcones: Lucide Icons
- Fontes: Geist, Inter
- Cores customizadas via CSS variables
- Responsivo: Grid layout adaptativo

## Conven√ß√µes de C√≥digo

### JavaScript/Node.js
- Usar template literals com cuidado (problemas conhecidos com HTML)
- Preferir concatena√ß√£o de strings para HTML complexo
- Usar async/await para opera√ß√µes ass√≠ncronas

### Python
- Scripts de gerenciamento em Python 3
- Usar path.join para caminhos multiplataforma
- Verificar processos antes de iniciar/parar

### Cliente Python (root)
- **N√ÉO usar `lambdas`** no `serverCommandList` ou em callbacks do `stringCommander.py`. O sistema utiliza inspe√ß√£o de objeto (`im_func`) que falha com fun√ß√µes an√¥nimas, causando crash no carregamento da fase de jogo.
- Sempre declarar m√©todos de classe (`def __Metodo(self):`) e us√°-los como callback (`"comando": self.__Metodo`).
- **Verifica√ß√£o de Pasta Ativa**: O cliente pode ler da pasta `assets/root/` ou do arquivo compactado `root.pck`. Sempre valide se as altera√ß√µes est√£o ativas usando um comando de chat de debug (ex: `/DEBUG_ROOT`).
- Se as altera√ß√µes na pasta `assets` n√£o refletirem, √© necess√°rio recompilar os arquivos `.pck` usando o `PackMaker.exe`.

### SQL
- Sempre validar sintaxe antes de executar
- Usar transa√ß√µes quando apropriado
- Backup antes de altera√ß√µes estruturais

## Notas Importantes
- O projeto usa Bun como runtime JavaScript (alternativa ao Node.js)
- Porta 8080 pode estar ocupada - sempre verificar antes de iniciar
- Quests precisam ser compiladas antes do servidor iniciar completamente
- Sistema de logs em `channels/*/log/` e `syslog.log`, `syserr.log`

## Aprendizados de Implementa√ß√£o: Pickup Highlight

### üîç Estrutura de Execu√ß√£o (Cores/N√∫cleos)
- No Metin2 Windows Server, cada canal pode ter m√∫ltiplos n√∫cleos (**Cores**).
- Cada mapa do jogo pode estar em um core diferente (ex: Mapa 1 no core2, Mapa 2 no core1).
- **CR√çTICO**: O `game.exe` compilado deve ser copiado para TODOS os n√∫cleos (`channel1/core1`, `channel1/core2`, etc.) e renomeado adequadamente (ex: `channel1_core1.exe`).
- O `start.py` executa os arquivos individuais de cada pasta. Se voc√™ atualizar apenas um, o efeito n√£o aparecer√° em outros mapas.

### üõ°Ô∏è L√≥gica de Highlight (BHighlight)
- **Problema de Relog/Mover**: Se o `bHighlight` tiver valor padr√£o `true`, o efeito de brilho aparecer√° toda vez que o player logar ou mover itens no invent√°rio.
- **Solu√ß√£o Ideal**: 
    1. Definir o valor padr√£o de `bHighlight` como `false` nas declara√ß√µes das fun√ß√µes (`item.h`).
    2. Passar `true` explicitamente **apenas** nas origens desejadas: `CShop::Buy` (comprar no NPC) e `CHARACTER::PickupItem` (pegar do ch√£o).
    3. Remover travas de `LastOwnerPID` no `item.cpp`, pois agora o controle de "quem brilha" √© feito na chamada da fun√ß√£o, n√£o na l√≥gica interna do item.

### üìù Depura√ß√£o Eficiente (C++)
- Usar `sys_err` com prefixos identific√°veis (ex: `[DEBUG_ITEM]`, `[DEBUG_PICKUP]`) para facilitar a filtragem via grep/PowerShell.
- Incluir `__DATE__` e `__TIME__` nos logs de inicializa√ß√£o (`Initialize`) para confirmar que o bin√°rio que est√° rodando √© realmente a vers√£o mais recente compilada.
- Sempre verificar qual `syserr.log` de qual core o personagem est√° gerando logs para evitar confus√£o de "log n√£o aparecendo".

## Aprendizados de Implementa√ß√£o: UI e Logs

### üêç Interface Python/C++
- **Exposi√ß√£o de Flags**: Ao usar diretivas de pr√©-processador (`#ifdef`) no C++ para controlar features, elas DEVEM ser expostas ao Python explicitamente.
  - Arquivo: `UserInterface/PythonApplicationModule.cpp` (ou similar).
  - M√©todo: `PyModule_AddIntConstant(poModule, "NOME_DA_FLAG", 1);`.
  - Sintoma de erro: `AttributeError: 'module' object has no attribute 'NOME_DA_FLAG'` no `syserr.txt`.

### üõ°Ô∏è Inicializa√ß√£o e Estabilidade de UI
- **Inicializa√ß√£o Completa**: Sempre inicialize todas as listas, dicion√°rios e vari√°veis de membro no m√©todo `__init__` das classes de janela (ex: `uitarget.py`).
  - Problema: M√©todos como `SetTarget` ou `OnUpdate` podem ser chamados por pacotes de rede antes que a janela seja "aberta" ou totalmente carregada.
  - Sintoma: `AttributeError: 'Classe' object has no attribute 'lista_filhos'`.
- **Valida√ß√£o de Constantes**: Adicione verifica√ß√µes de seguran√ßa (`hasattr`) no in√≠cio dos scripts Python se eles dependerem de constantes que podem n√£o existir em bin√°rios antigos.
  ```python
  if not hasattr(app, "FEATURE_FLAG"):
      app.FEATURE_FLAG = 0
  ```

### üìú An√°lise de Logs (Client)
- **Filtragem de Ru√≠do**: O `syserr.txt` do cliente √© frequentemente inundado com logs de pacotes de rede (`HEADER_GC_CHARACTER_MOVE`, etc.).
- **T√©cnica**: Use `grep -a` (ou `Select-String` no PowerShell) para filtrar por erros espec√≠ficos ou padr√µes de debug, ignorando o ru√≠do.
  - Exemplo: `grep -a "TARGET_INFO" syserr.txt` para ver apenas logs da feature espec√≠fica.
