---
trigger: always_on
---

# Metin2 Server Project

This project is a Metin2 server environment running on FreeBSD. It consists of the C++ source code for the server binaries and the runtime server files with management scripts.

## Project Structure

The project is divided into two main directories:

*   **`m2_source/`**: Contains the source code for the game server, database server, and support libraries.
    *   `Server/`: The main build directory containing the master `Makefile`.
    *   `Server/game/src/`: Source code for the main game binary.
    *   `Server/db/src/`: Source code for the database cache binary.
    *   `Server/common/`, `Server/lib*`: Shared headers and libraries.
    *   `Extern/`: External dependencies (cryptopp, etc.).

*   **`m2server/`**: The runtime directory where the server is executed.
    *   `main/`: Contains management scripts (`admin_panel.sh`, `start.py`, etc.) and configuration generators.
    *   `sql/`: Database schema and update files.
    *   `baks/`: Backup storage and Makefiles for DB/FS backups.

## Building the Source

The source code is built using `gmake` (GNU Make) and GCC 12.

**Location:** `m2_source/Server/`

### Key Commands

*   **Build All:**
    ```bash
    cd m2_source/Server
    gmake all
    ```
    *This cleans the project, updates the revision, and builds all libraries, game, and db binaries.*

*   **Quick Build (Incremental):**
    ```bash
    cd m2_source/Server
    gmake default
    ```
    *Builds modified files without cleaning first.*

*   **Clean:**
    ```bash
    cd m2_source/Server
    gmake clean
    ```

*   **Strip Binaries (Reduce size):**
    ```bash
    cd m2_source/Server
    gmake strip
    ```

### Libraries & Dependencies
The build system handles the following internal libraries automatically:
*   `liblua` (Lua 5.0)
*   `libsql`
*   `libgame`
*   `libpoly`
*   `libthecore`

## Running and Managing the Server

The server is managed via the `admin_panel.sh` script located in `m2server/main/`.

**Location:** `m2server/main/`

### Prerequisites
Ensure scripts have execution permissions:
```bash
chmod u+x *.py *.sh
```

### Management Commands

*   **Start Server:**
    ```bash
    sh admin_panel.sh start
    ```

*   **Stop Server:**
    ```bash
    sh admin_panel.sh stop
    ```

*   **Clean Logs:**
    ```bash
    sh admin_panel.sh clear
    ```

*   **Generate Configuration:**
    The server uses `gen.py` to generate configuration files based on `gen_settings.py` and the database.
    ```bash
    sh admin_panel.sh gen
    ```

### Advanced Usage

*   **Interactive Start:** `sh admin_panel.sh starti` (Select specific channels/cores)
*   **Daemon Mode:** `sh admin_panel.sh startall` (Keeps processes running)
*   **Backups:**
    *   DB: `sh admin_panel.sh bak1`
    *   FS: `sh admin_panel.sh bak2`

## Database

The SQL files are located in `m2server/sql/`. The primary schemas are:
*   `account.sql`
*   `common.sql`
*   `player.sql`
*   `log.sql`

## Notes
*   **Compiler:** The Makefile is hardcoded to use `gcc12` and `g++12`. Ensure these are installed (`pkg install gcc12`).
*   **Platform:** Designed for FreeBSD.
*   **Configuration:** Do not manually edit `config` files generated by the system; modify `gen_settings.py` or the `M2CONFIG` database table instead.

## Histórico de Manutenção

### [24/12/2025] - Correções de Compilação e ABI
- **CryptoPP**:
    - Recompilação completa da biblioteca `libcryptopp.a` usando `g++12` para garantir compatibilidade ABI.
    - Correção no arquivo `Extern/cryptopp/filters.h`: declaração do construtor corrigida para C++20.
- **Makefiles**:
    - **game/src/Makefile**: Adicionados caminhos de inclusão e biblioteca para a pasta `Extern`.
    - **db/src/Makefile**: Corrigido erro de sintaxe (`-I` para `-L`) no `LIBDIR`.
- **Resultado**:
    - Compilação bem-sucedida da revisão **41028**.

### [24/12/2025] - Resolução de Segmentation Fault e Caminhos de Execução
- **Conflito de Bibliotecas (Segmentation Fault)**:
    - Identificado crash no `questmanager.cpp` ao abrir arquivos com `std::ifstream` devido ao conflito entre `libstdc++` (GCC) e `libc++` (FreeBSD/LLVM).
    - **Solução**: Adicionadas as flags `-static-libstdc++` e `-static-libgcc` nos `Makefiles` do `game` e `db` para forçar a vinculação estática das bibliotecas do GCC.
- **Links Simbólicos de Execução**:
    - Os links em `m2server/main/srv1/share/bin/` apontavam para um caminho absoluto inexistente (`/home/s3ll_server/...`).
    - **Solução**: Corrigidos os links simbólicos para apontarem para o diretório correto do projeto (`/home/m2_source/Server/...`).
- **Persistência de Processos**:
    - Utilizado o utilitário `daemon -f` para garantir que os binários iniciem de forma desacoplada do terminal e não recebam sinais de fechamento (`SIGHUP`).
### [24/12/2025] - Instalação do Novo Servidor (M2-Dev) e Ferramentas Interativas
- **Clone e Limpeza**:
    - Repositório `https://github.com/furkanguclu/M2-Dev` clonado em `/home/M2-Dev`.
    - Removidos diretórios de cliente (`m2dev-client`, `m2dev-client-src`) para focar no servidor.
- **Compilação (GCC 12 + CMake)**:
    - Correção no arquivo `src/qc/qc.cpp`: Adicionado `#include <cstring>` para resolver falta de declaração de `strlen` e `strcmp`.
    - **Solução de ABI**: Adicionadas as flags de linkagem `-static-libgcc` e `-static-libstdc++` no `CMakeLists.txt` para garantir portabilidade no FreeBSD.
    - Binários `game`, `db` e `qc` compilados com sucesso.
- **Banco de Dados (MariaDB)**:
    - Senha do root redefinida para `dev`.
    - Criado usuário `mt2` (senha `mt2`) com acesso via `localhost` e `127.0.0.1`.
    - Criados bancos de dados `account`, `common`, `log` e `player` e importados os schemas SQL originais.
- **Gestão do Servidor**:
    - **start.py**: Atualizado para usar `daemon -f` no FreeBSD, garantindo que os processos não morram ao fechar o terminal. Aumentado o tempo de espera após o início do DB para 5 segundos.
    - **admin_panel.py**: Criado um novo painel interativo com arte ASCII "**JAMES2**", emojis e menu completo (Start, Stop, Restart, Clear, Status).
    - **Melhoria de Status**: Implementada checagem via `sockstat -4l` para identificar processos reais ouvindo nas portas, garantindo precisão no painel.
- **Status Final**: Servidor 100% operacional (DB, Auth, CH1, CH99) e acessível via novo painel.

### [25/12/2025] - Correção e Compilação do Sistema de Quests
- **Compilador Quest (qc)**:
    - O binário `qc` original na pasta de locale apresentava erro de layout de arquivo (ABI mismatch).
    - **Solução**: Substituído pelo binário `qc` compilado localmente (`/home/M2-Dev/m2dev-server/share/bin/qc`), garantindo compatibilidade com as bibliotecas do sistema.
- **Script de Automação (make.py)**:
    - O script tentava realizar `chgrp` para um grupo inexistente (`quest`), interrompendo o processo.
    - **Solução**: Removida a lógica de grupo inexistente e mantida apenas a gestão de permissões (`chmod`).
- **Compilação e Permissões**:
    - Executada a compilação de todas as quests listadas em `locale_list`, gerando a pasta `object`.
    - Aplicado `chmod -R 777` na pasta `object` para garantir que o processo do jogo (mesmo se rodar como outro usuário) tenha acesso de leitura às quests.
- **Resultado**: Quests operacionais no jogo após `/reload q`.



---
© 2025 James2 - Metin2 Server Management Environment.
### [26/12/2025] - Documentação UI
- **Adicionado**: Referência à documentação técnica do sistema de UI.
    - Detalhes sobre Layers, Windows, Picking e interação Python/C++ estão disponíveis em `.agent/rules/python-ui.md`.

### [26/12/2025] - Comunicação via Pacotes (Protocolo)
- **Adicionado**: Guia completo sobre implementação de pacotes GC (Game-Client) e CG (Client-Game).
    - O guia detalha structs, headers, registro no Stream e tratamento no Servidor/Cliente.
    - Disponível em `.agent/rules/packets.md`.

### [26/12/2025] - Correção e Compilação do Sistema de Quests
- **Adicionado**: Guia de desenvolvimento de Quests (Lua).
    - Cobre triggers, condições (with), funções essenciais e fluxo de implementação.
    - Disponível em `.agent/rules/questing.md`.

### [26/12/2025] - Correção de Item Proto (Pedra de Resfriamento+5)
- **Problema**: O item `28532` (Pedra de Resfriamento+5) estava configurado como `ITEM_NONE` e não equipável.
- **Correção Server-Side**:
    - Atualizado `item_proto.txt` (Server/DB) para `ITEM_METIN`, `WEAR_WEAPON` e `APPLY_CAST_SPEED` (35%).
- **Correção Client-Side**:
    - Compilada a ferramenta `dump_proto` a partir do source.
    - Gerado binário `item_proto` atualizado e aplicado em `locale_pt` / `locale_en`.
    - Reempacotados `locale_pt.pck` e `locale_en.pck` com `PackMaker`.
- **Documentação**:
    - Criado guia de gerenciamento de Proto em `.agent/rules/proto-management.md`.
